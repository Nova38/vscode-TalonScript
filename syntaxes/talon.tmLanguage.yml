---
name: TalonScript
patterns:
  - include: "#body-header"
  - include: "#header"
  - include: "#body-noheader"
  - include: "#comment"
  - include: "#settings"
repository:
  header:
    begin: (?=^app:|title:|os:)
    end: (?=^-$)
    patterns:
      - include: "#comment"
      - include: "#context"
  context:
    match: "(.*): (.*)"
    captures:
      "1":
        name: entity.name.tag.talon
        patterns:
          - match: (and |or )
            name: keyword.operator.talon
      "2":
        name: entity.name.type.talon
        patterns:
          - include: "#comment"
          - match: (/.*/)
            name: string.regexp.talon
  body-header:
    begin: ^-$
    end: (?=not)possible
    patterns:
      - include: "#body-noheader"
  body-noheader:
    patterns:
      - include: "#comment"
      - include: "#rule-definition"
      - include: "#statement-indented"
  capture:
    match: (\<[a-zA-Z0-9._]+\>)
    name: variable.parameter.talon
  list:
    match: ({[a-zA-Z0-9._]+?})
    name: string.interpolated.talon
  comment:
    match: (\s*#.*)$
    name: comment.line.number-sign.talon
  fstring:
    match: ({.+?})
    name: constant.character.format.placeholder.talon
  qstring:
    patterns:
      - include: "#qstring-double"
      - include: "#qstring-single"
  qstring-double:
    match: (")(.*?(?<!\\))(")
    name: string.quoted.double.talon
    captures:
      "1":
        name: punctuation.definition.string.begin.talon
      "2":
        patterns:
          - match: "{{|}}"
            name: string.quoted.double.talon
          - include: "#fstring"
          - include: "#key-mods"
          - include: "#key-prefixes"
      "3":
        name: punctuation.definition.string.end.talon
  qstring-single:
    match: (')(.*?(?<!\\))(')
    name: string.quoted.single.talon
    captures:
      "1":
        name: punctuation.definition.string.begin.talon
      "2":
        patterns:
          - match: "{{|}}"
            name: string.quoted.single.talon
          - include: "#fstring"
          - include: "#key-mods"
          - include: "#key-prefixes"
      "3":
        name: punctuation.definition.string.end.talon
  action-key:
    match: key(\()(.*)(\))
    name: entity.name.function.talon
    captures:
      "1":
        name: punctuation.definition.parameters.begin.talon
      "2":
        name: variable.parameter.talon
        patterns:
          - include: "#qstring"
          - include: "#key-prefixes"
          - include: "#key-mods"
      "3":
        name: punctuation.definition.parameters.key.talon
  key-prefixes:
    match: (ctrl|shift|cmd|alt|win|super)(-)
    captures:
      "1":
        name: keyword.control.talon
      "2":
        name: keyword.operator.talon
  key-mods:
    match: (:)(up|down|\d+)
    captures:
      "1":
        name: keyword.operator.talon
      "2":
        name: keyword.control.talon
    name: keyword.operator.talon
  argsep:
    match: ","
    name: punctuation.separator.talon
  action:
    match: "([a-zA-Z0-9._]+)(\\()(.*?)(\\))"
    # name: support.function.builtin.talon
    captures:
      "1":
        name: entity.name.function.talon
        patterns:
          - match: "\\."
            name: punctuation.separator.talon
      "2":
        name: punctuation.definition.parameters.begin.talon
      "3":
        patterns:
          - include: "#qstring"
          - include: "#argsep"
          - include: "#number"
          - include: "#operators"
        name: variable.parameter.talon
      "4":
        name: punctuation.definition.parameters.end.talon
  action-action:
    match: action(\()(.*)(\))
    name: entity.name.function.talon
    captures:
      "1":
        name: punctuation.definition.parameters.begin.talon
      "2":
        name: variable.parameter.talon
      "3":
        name: punctuation.definition.parameters.end.talon
  rule-definition:
    match: ^([^\s][^"']*):\s*(.*)$
    captures:
      "1":
        name: entity.name.tag.talon
        patterns:
          - match: settings(\(\))
            name: entity.name.function.talon
            captures:
              "1":
                name: punctuation.definition.parameters.begin.talon
          - include: "#action-key"
          - include: "#action-action"
          - include: "#capture"
          - include: "#list"
      "2":
        patterns:
          - include: "#statement"
  operators:
    match: \s(\+|-|\*|/|or)\s
    name: keyword.operator.talon
  number:
    match: (?<=\b)\d+(\.\d+)?
    # (?=$|\s)
    name: constant.numeric.talon
  assignment:
    match: (\S*)(\s?=\s?)(.*)
    captures:
      "1":
        name: variable.other.talon
      "2":
        name: keyword.operator.talon
      "3":
        name: variable.other.talon
        patterns:
          - include: "#comment"
          - include: "#operators"
          - include: "#number"
          - include: "#qstring"
  statement-indented:
    match: ^\s+(.*)$
    captures:
      "1":
        patterns:
          - include: "#statement"
  statement:
    patterns:
      - include: "#comment"
      - include: "#action-key"
      - include: "#action"
      - include: "#qstring"
      - include: "#assignment"
      - include: "#operators"
scopeName: source.talon
